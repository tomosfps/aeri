name: Build And Push Docker images

on:
  push:
    branches:
      - 'main'

jobs:
  build_base_layers:
    name: Build Docker base layers for caching
    runs-on: ubuntu-latest
    steps:
      -
        name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Build base layers
        uses: docker/build-push-action@v6
        with:
          target: build
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build_node_images:
    name: Build and push Docker images based on Node.JS
    needs: build_base_layers
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          -
            target: handler
            tags: r2.ecchi.cloud/aeri_handler
          -
            target: gateway
            tags: r2.ecchi.cloud/aeri_gateway
          -
            target: database-setup
            tags: r2.ecchi.cloud/aeri_database-setup
          -
            target: website
            tags: r2.ecchi.cloud/aeri_website
    steps:
      -
        name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Login to docker registry
        uses: docker/login-action@v3
        with:
          registry: r2.ecchi.cloud
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      -
        name: Build and push ${{ matrix.target }} image
        uses: docker/build-push-action@v6
        with:
          target: ${{ matrix.target }}
          push: true
          tags: ${{ matrix.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build_api_image:
    name: Build and push Rust API image
    runs-on: ubuntu-latest
    steps:
      -
        name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      -
        name: Login to docker registry
        uses: docker/login-action@v3
        with:
          registry: r2.ecchi.cloud
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      -
        name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          file: ./Dockerfile.api
          push: true
          tags: r2.ecchi.cloud/aeri_api
          cache-from: type=gha
          cache-to: type=gha,mode=max
